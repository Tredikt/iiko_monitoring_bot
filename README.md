# Telegram-бот для аналитики iikoCloud

Telegram-бот для получения и отображения аналитики из iikoCloud API через inline-кнопки.

## Установка

### Вариант 1: Docker (рекомендуется)

1. Клонируйте репозиторий или скопируйте файлы проекта

2. Создайте файл `.env` (скопируйте из `env.example.txt`):
```bash
# Windows
copy env.example.txt .env

# Linux/Mac
cp env.example.txt .env
```

3. Заполните `.env` файл (минимум требуется `BOT_TOKEN` и `IIKO_API_LOGIN`):
```
BOT_TOKEN=your_telegram_bot_token
ADMIN_TG_ID=your_telegram_user_id
IIKO_API_LOGIN=your_iiko_api_login
```

4. Запустите через Docker Compose:
```bash
docker-compose up -d
```

Бот будет запущен в контейнере. Логи можно посмотреть:
```bash
docker-compose logs -f bot
```

Остановка:
```bash
docker-compose down
```

### Вариант 2: Локальная установка

1. Клонируйте репозиторий или скопируйте файлы проекта

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` (скопируйте из `env.example.txt`):
```bash
# Windows
copy env.example.txt .env

# Linux/Mac
cp env.example.txt .env
```

4. Заполните `.env` файл (см. раздел "Настройка .env")

5. Запустите бота:
```bash
python main.py
```

## Настройка .env

Обязательные параметры:
- `BOT_TOKEN` - токен Telegram бота (получить у @BotFather)
- `IIKO_API_LOGIN` - логин для локального iiko API
- `IIKO_API_PASSWORD` - пароль для локального iiko API

Опциональные параметры:
- `ADMIN_TG_ID` - Telegram user_id администратора
- `IIKO_BASE_URL` - базовый URL локального iiko API (по умолчанию: https://dreamteam-co.iiko.it/resto/api)
- `DEFAULT_REPORT_TIME` - время ежедневного отчёта (формат HH:MM, по умолчанию: 23:00)
- `DEFAULT_ALERT_THRESHOLD_PCT` - порог падения выручки для алерта в процентах (по умолчанию: 15)
- `DEFAULT_ROLLING_DAYS` - количество дней для расчёта скользящего среднего (по умолчанию: 7)
- `TZ` - часовой пояс для планировщика (по умолчанию: Europe/Moscow)

**Примечание:** Бот автоматически выберет первую организацию из списка при первом запуске.

## Описание кнопок

### Главное меню

После команды `/start` отображается меню с кнопками:

- **Сегодня** - показать метрики за сегодня
- **Вчера** - показать метрики за вчера
- **Неделя** - показать метрики за последние 7 дней
- **Месяц** - показать метрики за последние 30 дней
- **Фудкост** - показать детальную информацию о фудкосте
- **Организации** - список организаций
- **Терминалы** - список терминалов

## Архитектура

### Структура проекта

```
.
├── bot/
│   ├── main.py          # Точка входа, инициализация бота
│   ├── handlers.py      # Обработчики сообщений и callback'ов
│   ├── keyboards.py     # Клавиатуры с inline-кнопками
│   └── scheduler.py     # Планировщик ежедневных отчётов
├── iiko/
│   └── client.py        # Клиент для работы с iikoCloud API
├── services/
│   └── analytics.py     # Сервис аналитики и расчёта метрик
├── config.py            # Конфигурация из .env
├── requirements.txt     # Зависимости
├── Dockerfile           # Docker образ для бота
├── docker-compose.yml   # Docker Compose конфигурация
└── README.md            # Документация
```

### Компоненты

1. **bot/main.py** - инициализирует бота, диспетчер, клиент iiko, сервис аналитики и планировщик

2. **bot/handlers.py** - обрабатывает:
   - Команду `/start` - показывает главное меню
   - Callback'и для периодов (today, yesterday, week, month)
   - Callback'и для фудкоста
   - Проверку доступа (только для ADMIN_TG_ID)

3. **bot/keyboards/** - создаёт inline-клавиатуры для меню

4. **bot/scheduler.py** - планировщик ежедневных отчётов:
   - Отправляет отчёт в указанное время
   - Сравнивает выручку с rolling average
   - Отправляет алерт при падении >= threshold

5. **iiko/client.py** - асинхронный клиент для iikoCloud API:
   - Получение токена с кешированием
   - Получение списка организаций
   - Получение метрик продаж (с retry и timeout)

6. **services/analytics.py** - сервис аналитики:
   - Получение метрик за период
   - Сравнение с вчерашним днём
   - Расчёт rolling average


### Безопасность

- Доступ только для пользователя с указанным `ADMIN_TG_ID`
- Все остальные пользователи получают сообщение "Доступ запрещён"
- Проверка доступа выполняется во всех handlers

### Особенности

- Интерфейс ТОЛЬКО через inline-кнопки (команды типа /today не используются)
- Автоматическое определение организации при первом запуске
- Ежедневные отчёты в 23:00 с алертами при падении выручки
- Retry логика для API запросов (3 попытки)
- Timeout 30 секунд для всех API запросов
- Docker-контейнеризация

## TODO

- Реализовать фактический endpoint для получения метрик продаж в `iiko/client.py` (сейчас используется абстракция)
- Уточнить структуру ответа API iikoCloud для метрик продаж

